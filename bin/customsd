#!/bin/bash

if [ -z "$SONOS_IP" ]; then
  echo "SONOS_IP unset" >&2
  exit 1
fi

set -x
set -e

if [ "$1" = "dev" ]; then
  LOCAL_IP=$(ifconfig -a | grep 'inet ' | grep broadcast | awk '{ print $2 }')
  HOST="http://$LOCAL_IP:3000"
  SECURE_HOST="$HOST"
else
  HOST="http://overcast-sonos.herokuapp.com"
  SECURE_HOST="https://overcast-sonos.herokuapp.com"
fi

SID="255"
NAME="Overcast"
URI="$HOST/smapi.php"
SECURE_URI="$SECURE_HOST/smapi.php"
POLL_INTERVAL=10
AUTH_TYPE="UserId"
STRINGS_VERSION=1
STRINGS_URI="$SECURE_HOST/strings.xml"
PRESENTATION_MAP_VERSION=0
PRESENTATION_MAP_URI=""
CONTAINER_TYPE="SoundLab"

curl -v "http://$SONOS_IP:1400/customsd" \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode "sid=$SID" \
  --data-urlencode "name=$NAME" \
  --data-urlencode "uri=$URI" \
  --data-urlencode "secureUri=$SECURE_URI" \
  --data-urlencode "pollInterval=$POLL_INTERVAL" \
  --data-urlencode "authType=$AUTH_TYPE" \
  --data-urlencode "stringsVersion=$STRINGS_VERSION" \
  --data-urlencode "stringsUri=$STRINGS_URI" \
  --data-urlencode "presentationMapVersion=$PRESENTATION_MAP_VERSION" \
  --data-urlencode "presentationMapUri=$PRESENTATION_MAP_URI" \
  --data-urlencode "containerType=$CONTAINER_TYPE"

exit
